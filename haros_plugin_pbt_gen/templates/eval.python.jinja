{% import 'rv_common.python.jinja' as rv %}

{##############################################################################
    Pattern Monitor Macros
 ##############################################################################}

{% macro _eval_absence(monitor) -%}
{% if monitor.has_scope_timeout %}
if scope_clock >= {{ monitor.scope_timeout }}:
    break # to the next scope
{% endif %}
{{ _check_event(monitor.behaviour) }}
if found:
    return False
{%- endmacro %}


{% macro _eval_existence(monitor) -%}
{% if monitor.has_scope_timeout %}
if scope_clock >= {{ monitor.scope_timeout }}:
    return False
{% endif %}
{{ _check_event(monitor.behaviour) }}
if found:
    break
{%- endmacro %}


{% macro _eval_precedence(monitor) -%}
{% set a = monitor.trigger.events[0] %}{# FIXME: this is a hammer #}
{% set b = monitor.behaviour.events[0] %}{# FIXME: this is a hammer #}
if topic == "{{ b.topic }}"{{ rv.inline_conditions(b.conditions) }}:
    b_msg = msg
{% if a.has_log_age %}
    clock = 0.0
{% endif %}
    for j in range(i - 1, -1, -1):
        event2 = scope.events[j]
{% if a.has_log_age %}
        clock += scope.events[j+1].timestamp / 1000.0
        if clock > {{ a.log_age }}:
            return False
{% endif %}
        if event2.topic == "{{ a.topic }}"{# -#}
                {{ rv.inline_conditions(a.conditions) }}:
{% if b.dep_conditions.get(a.key()) %}
    {% if a.saved_vars %}
            entry = scope
        {% for key, msg_field in a.saved_vars.items() %}
            scope.state[{{ key }}] = msg.{{ msg_field }}
        {% endfor %}
    {% endif %}
            if True{# -#}
            {{ rv.inline_conditions(b.get_dep_conditions(a.key()), msg='b_msg') }}:
                break # stop searching the past
{% else %}
            break # stop searching the past
{% endif %}
    else:
        return False
{%- endmacro %}


{% macro _eval_response(monitor) -%}
{% set a = monitor.trigger.events[0] %}{# FIXME: this is a hammer #}
{% set b = monitor.behaviour.events[0] %}{# FIXME: this is a hammer #}
{{ _check_event(monitor.trigger) }}
if found:
{% if b.is_under_timer %}
    clock = 0.0
{% endif %}
    for j in range(i+1, len(scope.events)):
        event2 = scope.events[j]
{% if b.is_under_timer %}
        clock += event2.timestamp / 1000.0
        if clock > {{ a.external_timer }}:
            return False
{% endif %}
        if event2.topic == "{{ b.topic }}"{# -#}
                {{ rv.inline_conditions(b.conditions, msg='event2.msg') }}:
            break # stop searching the future
    else:
        return False
{%- endmacro %}


{% macro _eval_prevention(monitor) -%}
{% set a = monitor.trigger.events[0] %}{# FIXME: this is a hammer #}
{% set b = monitor.behaviour.events[0] %}{# FIXME: this is a hammer #}
{{ _check_event(monitor.trigger) }}
if found:
{% if b.is_under_timer %}
    clock = 0.0
{% endif %}
    for j in range(i + 1, len(scope.events)):
        event2 = scope.events[j]
{% if b.is_under_timer %}
        clock += event2.timestamp / 1000.0
        if clock > {{ a.external_timer }}:
            break # stop searching the future
{% endif %}
        if event2.topic == "{{ b.topic }}"{# -#}
                {{ rv.inline_conditions(b.conditions, msg='event2.msg') }}:
            return False
{%- endmacro %}


{##############################################################################
    Property Monitor Macros
 ##############################################################################}

{% macro _initial_state(monitor) -%}
{% if monitor.saved_vars -%}
[None] * {{ monitor.saved_vars }}
{%- else -%}
()
{%- endif %}
{%- endmacro %}


{% macro _check_event(event, var_topic='topic', var_msg='msg') -%}
{% set event = event.events[0] %}{# FIXME: this is a hammer -#}
found = False
if {{ var_topic }} == "{{ event.topic }}"{# -#}
        {{ rv.inline_conditions(event.conditions, msg=var_msg) }}:
    found = True
{% if event.saved_vars %}
    {% for key, msg_field in event.saved_vars.items() %}
    scope.state[{{ key }}] = msg.{{ msg_field }}
    {% else %}
    # no variables to save
    {% endfor %}
{% endif %}
{%- endmacro %}


{% macro _eval_scope(monitor, first=true) -%}
scope_clock = 0.0
{% if first %}
if scope.events:
    scope_clock -= scope.events[0].timestamp / 1000.0
{% endif %}
for i in range(len(scope.events)):
    event = scope.events[i]
    msg = event.msg
    topic = event.topic
    scope_clock += event.timestamp / 1000.0
{% if monitor.is_absence %}
{{ _eval_absence(monitor)|indent(width=4, first=true) }}
{% elif monitor.is_existence %}
{{ _eval_existence(monitor)|indent(width=4, first=true) }}
else:
    return False
{% elif monitor.is_precedence %}
{{ _eval_precedence(monitor)|indent(width=4, first=true) }}
{% elif monitor.is_response %}
{{ _eval_response(monitor)|indent(width=4, first=true) }}
{% elif monitor.is_prevention %}
{{ _eval_prevention(monitor)|indent(width=4, first=true) }}
{% else %}
    pass
{% endif %}
{%- endmacro %}


{% macro _globally(monitor) -%}
e = scope = EvalScope(trace.events, {{ _initial_state(monitor) }})
{{ _eval_scope(monitor, first=false) }}
{%- endmacro %}

{% macro _after_p(monitor) -%}
e = scope = EvalScope([], {{ _initial_state(monitor) }})
for i in range(len(trace.events)):
    event = trace.events[i]
{{ _check_event(monitor.activator)|indent(width=4, first=true) }}
    if found:
        scope.events.extend(trace.events[i:])
        break
{{ _eval_scope(monitor, first=true) }}
{%- endmacro %}

{% macro _until_q(monitor) -%}
e = scope = EvalScope([], {{ _initial_state(monitor) }})
for i in range(len(trace.events)):
    event = trace.events[i]
{{ _check_event(monitor.terminator)|indent(width=4, first=true) }}
    if found:
        break
    scope.events.append(event)
{{ _eval_scope(monitor, first=false) }}
{%- endmacro %}

{% macro _after_p_until_q(monitor) -%}
scopes = []
j = -1
scope = EvalScope([], {{ _initial_state(monitor) }})
for i in range(len(trace.events)):
{{ _check_event(monitor.activator)|indent(width=4, first=true) }}
    if j < 0 and found:
        j = i
{{ _check_event(monitor.terminator)|indent(width=4, first=true) }}
    if j >= 0 and found:
        scope.events.extend(trace.events[j:i])
        scopes.append(scope)
        scope = EvalScope([], {{ _initial_state(monitor) }})
        j = -1
if j >= 0:
    scope.events.extend(trace.events[j:])
    scopes.append(scope)
for scope in scopes:
    e = scope
{{ _eval_scope(monitor, first=true)|indent(width=4, first=true) }}
{%- endmacro %}


{##############################################################################
    Template Body
 ##############################################################################}

def eval_{{ monitor.class_name }}(trace):
    # {{ monitor.hpl_string }}
{% if monitor.activator is none %}
    {% if monitor.terminator is none %}
{{ _globally(monitor)|indent(width=4, first=true) }}
    {% else %}
{{ _until_q(monitor)|indent(width=4, first=true) }}
    {% endif %}
{% else %}
    {% if monitor.terminator is none %}
{{ _after_p(monitor)|indent(width=4, first=true) }}
    {% else %}
{{ _after_p_until_q(monitor)|indent(width=4, first=true) }}
    {% endif %}
{% endif %}
    return True
